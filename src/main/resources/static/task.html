<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>æ ¡å›­å¸®å¸® - è´´å§æ¨¡å¼ç‰ˆ</title>
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <script src="https://unpkg.com/vue@2/dist/vue.js"></script>
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <style>
        body { background-color: #f5f7fa; font-family: "Helvetica Neue",Helvetica,"PingFang SC",Arial,sans-serif; margin:0; padding:0; }
        .main-container { padding: 20px; max-width: 1000px; margin: 0 auto; }
        .header-box { background: #fff; padding: 15px 20px; box-shadow: 0 1px 4px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; sticky: top; }
        .school-badge { background: #409EFF; color: #fff; padding: 4px 10px; border-radius: 4px; font-size: 14px; margin-left: 10px; cursor: pointer; }

        /* --- è´´å§åˆ—è¡¨æ ·å¼ --- */
        .tieba-list { background: #fff; border-radius: 4px; min-height: 500px; }
        .tieba-item { padding: 18px; border-bottom: 1px solid #f0f0f0; display: flex; align-items: flex-start; cursor: pointer; transition: 0.2s; }
        .tieba-item:hover { background: #fafafa; }

        .tb-avatar { width: 45px; height: 45px; background: #eee; border-radius: 4px; text-align: center; line-height: 45px; color: #999; font-size: 12px; margin-right: 15px; flex-shrink: 0; }
        .tb-content { flex: 1; }
        .tb-title { font-size: 16px; font-weight: bold; color: #333; margin-bottom: 8px; display: flex; align-items: center; }
        .tb-title:hover { color: #409EFF; text-decoration: underline; }
        .tb-meta { font-size: 13px; color: #999; display: flex; gap: 15px; }
        .tb-reward { color: #F56C6C; font-weight: bold; font-size: 15px; margin-left: auto; }

        .status-badge { padding: 2px 6px; border-radius: 4px; font-size: 12px; margin-right: 8px; color: #fff; }
        .bg-wait { background: #67C23A; } /* å¾…æ¥å• */
        .bg-run { background: #409EFF; } /* è¿›è¡Œä¸­ */
        .bg-done { background: #909399; } /* å·²å®Œæˆ */

        /* --- å¸–å­è¯¦æƒ…å¼¹çª— --- */
        .thread-header { border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 15px; }
        .thread-title { font-size: 20px; font-weight: bold; margin-bottom: 10px; }
        .thread-info-row { margin-bottom: 8px; font-size: 14px; color: #666; }
        .thread-action { background: #f9f9f9; padding: 15px; border-radius: 4px; text-align: center; margin-bottom: 20px; border: 1px dashed #ddd; }

        /* æ¥¼å±‚/è¯„è®ºæ ·å¼ */
        .floor-item { display: flex; margin-bottom: 15px; border-bottom: 1px solid #f5f5f5; padding-bottom: 15px; }
        .floor-user { width: 80px; text-align: center; font-size: 12px; color: #666; margin-right: 15px; }
        .floor-avatar { width: 40px; height: 40px; background: #f2f2f2; border-radius: 4px; margin: 0 auto 5px; line-height: 40px; }
        .floor-content { flex: 1; font-size: 14px; line-height: 1.6; color: #333; }
        .floor-time { font-size: 12px; color: #ccc; margin-top: 5px; text-align: right; }

        /* å…¶ä»–æ ·å¼ä¿æŒä¹‹å‰çš„ */
        .msg-item { background: #fff; padding: 15px; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .msg-item:hover { background: #f9f9f9; }
        .chat-box { height: 350px; overflow-y: auto; background: #f5f7fa; padding: 15px; border-radius: 4px; margin-bottom: 10px; }
        .msg-row { margin-bottom: 15px; display: flex; flex-direction: column; }
        .msg-bubble { padding: 10px 15px; border-radius: 8px; max-width: 70%; word-break: break-all; font-size: 14px; }
        .msg-me { align-items: flex-end; } .msg-me .msg-bubble { background: #95ec69; }
        .msg-other { align-items: flex-start; } .msg-other .msg-bubble { background: #fff; }
    </style>
</head>
<body>
<div id="app">
    <!-- é¡¶éƒ¨ -->
    <div class="header-box">
        <div style="font-size: 22px; font-weight: bold; color: #303133;">
            <i class="el-icon-school"></i> æ ¡å›­å¸®å¸®
            <span v-if="currentSchool" class="school-badge" @click="changeSchool">{{ currentSchool.name }} (åˆ‡æ¢)</span>
        </div>
        <div>
            <span style="color:#666; margin-right:10px;">èº«ä»½:</span>
            <el-radio-group v-model="currentUserId" size="small" @change="handleUserChange">
                <el-radio-button :label="1">ç”¨æˆ·1</el-radio-button>
                <el-radio-button :label="2">ç”¨æˆ·2</el-radio-button>
            </el-radio-group>
            <el-button type="primary" size="small" icon="el-icon-edit" @click="dialogVisible = true" style="margin-left: 10px;">å‘å¸–æ±‚åŠ©</el-button>
        </div>
    </div>

    <div class="main-container">
        <el-tabs v-model="activeTab" type="card" @tab-click="handleTabClick">

            <!-- Tab 1: ä»»åŠ¡å¤§å… (è´´å§æ¨¡å¼) -->
            <el-tab-pane name="hall">
                <span slot="label"><i class="el-icon-s-order"></i> ä»»åŠ¡å¹¿åœº</span>

                <el-alert v-if="!currentSchool" title="è¯·å…ˆé€‰æ‹©å­¦æ ¡" type="warning" show-icon :closable="false"></el-alert>

                <div v-else class="tieba-list">
                    <!-- åˆ—è¡¨é¡¹ -->
                    <div class="tieba-item" v-for="task in taskList" :key="task.id" @click="openThread(task)">
                        <!-- å¤´åƒ/æ¥¼å±‚æ•° -->
                        <div class="tb-avatar" :style="{background: stringToColor(task.publisherId.toString())}">
                            U{{ task.publisherId }}
                        </div>
                        <!-- å†…å®¹ -->
                        <div class="tb-content">
                            <div class="tb-title">
                                <span class="status-badge bg-wait" v-if="task.status===0">å¾…æ¥å•</span>
                                <span class="status-badge bg-run" v-else-if="task.status===1">è¿›è¡Œä¸­</span>
                                <span class="status-badge bg-done" v-else>å·²ç»“æŸ</span>
                                {{ task.title }}
                            </div>
                            <div class="tb-meta">
                                <span><i class="el-icon-location-outline"></i> å–: {{ task.locationFrom }}</span>
                                <span><i class="el-icon-location"></i> é€: {{ task.locationTo }}</span>
                                <span><i class="el-icon-time"></i> {{ formatTime(task.createTime) }}</span>
                                <span><i class="el-icon-chat-dot-square"></i> å›å¤ {{ task.consultList ? task.consultList.length : 0 }}</span>
                            </div>
                        </div>
                        <!-- èµé‡‘ -->
                        <div class="tb-reward">ï¿¥{{ task.reward }}</div>
                    </div>

                    <div v-if="taskList.length===0" style="text-align: center; padding: 40px; color: #999;">
                        æœ¬æ ¡æš‚æ— å¸–å­ï¼ŒæŠ¢ä¸ªæ²™å‘å§~
                    </div>
                </div>
            </el-tab-pane>

            <!-- Tab 2: é£Ÿå ‚ (ä¿æŒä¸å˜) -->
            <el-tab-pane name="canteen">
                <span slot="label"><i class="el-icon-food"></i> é£Ÿå ‚ç¾é£Ÿ</span>
                <el-container style="height: 600px; border: 1px solid #eee; background: #fff;">
                    <el-aside width="200px" style="border-right: 1px solid #eee;">
                        <el-menu :default-active="activeCanteenId" @select="handleCanteenSelect">
                            <el-menu-item v-for="c in canteenList" :key="c.id" :index="c.id.toString()">{{ c.name }}</el-menu-item>
                        </el-menu>
                    </el-aside>
                    <el-main>
                        <div v-if="windowList.length===0" style="padding:20px; color:#999;">è¯·é€‰æ‹©é£Ÿå ‚</div>
                        <div v-for="win in windowList" :key="win.id" style="margin-bottom:15px; border:1px solid #eee; padding:10px;">
                            <div style="font-weight:bold; color:#E6A23C; margin-bottom:5px;">{{ win.name }} <span style="font-size:12px; color:#999;">{{win.floor}}</span></div>
                            <div v-for="d in win.dishList" :key="d.id" style="display:flex; justify-content:space-between; font-size:14px; margin-top:5px;">
                                <span>{{d.name}}</span><span style="color:#F56C6C;">ï¿¥{{d.price}}</span>
                            </div>
                        </div>
                    </el-main>
                </el-container>
            </el-tab-pane>

            <!-- Tab 3: æ¶ˆæ¯ (çº¢ç‚¹ä¿®å¤) -->
            <el-tab-pane name="msg">
                    <span slot="label">
                        <i class="el-icon-message-solid"></i> æ¶ˆæ¯
                        <!-- åªæœ‰å½“ unreadCount > 0 æ—¶æ‰æ˜¾ç¤ºçº¢ç‚¹ -->
                        <el-badge :value="unreadCount" class="item" v-if="unreadCount > 0" />
                    </span>
                <div v-if="inboxList.length===0" style="text-align: center; padding: 50px; color: #999;">æš‚æ— æ¶ˆæ¯</div>
                <div class="msg-item" v-for="item in inboxList" :key="item.targetId" @click="openChat(item.targetId)">
                    <div class="tb-avatar" :style="{background: stringToColor(item.targetName)}">{{ item.targetId }}</div>
                    <div style="flex:1;">
                        <div style="font-weight:bold;">{{ item.targetName }}</div>
                        <div style="color:#888; font-size:13px;">{{ item.lastContent }}</div>
                    </div>
                </div>
            </el-tab-pane>

            <!-- Tab 4: ä¸ªäººä¸­å¿ƒ -->
            <el-tab-pane name="profile" label="ä¸ªäººä¸­å¿ƒ">
                <el-tabs>
                    <el-tab-pane label="æˆ‘å‘å¸ƒçš„">
                        <el-table :data="myPubList"><el-table-column prop="title" label="æ ‡é¢˜"></el-table-column><el-table-column prop="status" label="çŠ¶æ€"></el-table-column></el-table>
                    </el-tab-pane>
                    <el-tab-pane label="æˆ‘æŠ¢åˆ°çš„">
                        <el-table :data="myAccList"><el-table-column prop="title" label="æ ‡é¢˜"></el-table-column><el-table-column label="æ“ä½œ"><template slot-scope="s"><el-button size="mini" @click="openChat(s.row.publisherId)">è”ç³»</el-button></template></el-table-column></el-table>
                    </el-tab-pane>
                </el-tabs>
            </el-tab-pane>
        </el-tabs>
    </div>

    <!-- 1. å¸–å­è¯¦æƒ…å¼¹çª— (Thread View) -->
    <el-dialog :visible.sync="threadVisible" width="600px" top="5vh">
        <div v-if="currentThread">
            <!-- æ¥¼ä¸»ä¿¡æ¯ -->
            <div class="thread-header">
                <div class="thread-title">
                    <span class="status-badge bg-wait" v-if="currentThread.status===0">å¾…æ¥å•</span>
                    <span class="status-badge bg-run" v-else-if="currentThread.status===1">è¿›è¡Œä¸­</span>
                    <span class="status-badge bg-done" v-else>å·²ç»“æŸ</span>
                    {{ currentThread.title }}
                    <span style="float: right; color: #F56C6C;">èµé‡‘ ï¿¥{{ currentThread.reward }}</span>
                </div>
                <div class="thread-info-row">ğŸ“ å–ä»¶ï¼š{{ currentThread.locationFrom }} --> é€è¾¾ï¼š{{ currentThread.locationTo }}</div>
                <div class="thread-info-row">ğŸ‘¤ æ¥¼ä¸»ï¼šç”¨æˆ·{{ currentThread.publisherId }} | ğŸ•’ å‘å¸ƒäº {{ formatTime(currentThread.createTime) }}</div>
            </div>

            <!-- æŠ¢å•æ“ä½œåŒº -->
            <div class="thread-action" v-if="currentThread.status === 0">
                <div v-if="currentThread.publisherId !== currentUserId">
                    <div style="margin-bottom: 10px; font-weight: bold; color: #67C23A;">è¿™å•è¿˜æ²¡äººæ¥ï¼Œå¿«æŠ¢ï¼</div>
                    <el-button type="success" icon="el-icon-lightning" @click="acceptTask(currentThread.id)">ç«‹å³æŠ¢å•èµšèµé‡‘</el-button>
                </div>
                <div v-else style="color: #999;">è¿™æ˜¯ä½ è‡ªå·±å‘å¸ƒçš„ä»»åŠ¡ï¼Œè¯·ç­‰å¾…æ¥å•...</div>
            </div>
            <div class="thread-action" v-else>
                <div style="font-weight: bold; color: #909399;">
                    è¯¥ä»»åŠ¡å·²è¢« <span style="color: #409EFF">ç”¨æˆ·{{ currentThread.acceptorId }}</span> æŠ¢èµ°
                </div>
            </div>

            <!-- è¯„è®º/å›å¤åŒº -->
            <div style="background: #fff;">
                <el-divider content-position="left">å…¨éƒ¨å›å¤ ({{ currentThread.consultList ? currentThread.consultList.length : 0 }})</el-divider>

                <!-- åˆ—è¡¨ -->
                <div v-for="c in currentThread.consultList" :key="c.id" class="floor-item">
                    <div class="floor-user">
                        <div class="floor-avatar" :style="{background: stringToColor(c.userId.toString())}">U{{c.userId}}</div>
                        <div>ç”¨æˆ·{{ c.userId }}</div>
                    </div>
                    <div class="floor-content">
                        {{ c.content }}
                        <div class="floor-time">{{ formatTime(c.createTime) }}</div>
                    </div>
                </div>

                <!-- è¾“å…¥æ¡† -->
                <div style="margin-top: 20px; display: flex;">
                    <el-input type="textarea" :rows="2" placeholder="çœ‹å¸–å›å¸–æ˜¯ç¾å¾·..." v-model="newComment"></el-input>
                    <el-button type="primary" style="margin-left: 10px; height: 54px;" @click="submitComment">å‘è¡¨<br>å›å¤</el-button>
                </div>
            </div>
        </div>
    </el-dialog>

    <!-- å…¶ä»–å¼¹çª— (å‘å¸ƒã€é€‰å­¦æ ¡ã€èŠå¤©) -->
    <el-dialog title="å‘å¸ƒå¸–å­" :visible.sync="dialogVisible" width="500px">
        <el-form :model="form" label-width="80px">
            <el-form-item label="æ ‡é¢˜"><el-input v-model="form.title"></el-input></el-form-item>
            <el-form-item label="èµé‡‘"><el-input v-model="form.reward"></el-input></el-form-item>
            <el-form-item label="å–ä»¶"><el-input v-model="form.locationFrom"></el-input></el-form-item>
            <el-form-item label="é€è¾¾"><el-input v-model="form.locationTo"></el-input></el-form-item>
        </el-form>
        <span slot="footer"><el-button type="primary" @click="submitTask">å‘å¸ƒ</el-button></span>
    </el-dialog>

    <el-dialog title="é€‰æ‹©æ ¡åŒº" :visible.sync="schoolDialogVisible" width="400px" :show-close="false">
        <el-select v-model="tempSchoolId" style="width:100%"><el-option v-for="s in schoolList" :key="s.id" :label="s.name" :value="s.id"></el-option></el-select>
        <span slot="footer"><el-button type="primary" @click="confirmSchool" :disabled="!tempSchoolId" style="width:100%">è¿›å…¥</el-button></span>
    </el-dialog>

    <el-dialog :title="'ä¸ ç”¨æˆ·'+chatTargetId+' ç§èŠ'" :visible.sync="chatVisible" width="500px" @close="handleCloseChat">
        <div class="chat-box" id="chatBox">
            <div v-for="m in chatHistory" :key="m.id" :class="['msg-row', m.senderId===currentUserId?'msg-me':'msg-other']"><div class="msg-bubble">{{m.content}}</div></div>
        </div>
        <div style="display: flex;"><el-input v-model="chatInput"></el-input><el-button @click="sendMsg">å‘é€</el-button></div>
    </el-dialog>
</div>

<script>
    new Vue({
        el: '#app',
        data: {
            currentUserId: 1, activeTab: 'hall',
            schoolList: [], currentSchool: null, tempSchoolId: null, schoolDialogVisible: true,
            taskList: [], inboxList: [], unreadCount: 0, // æ–°å¢çº¢ç‚¹è®¡æ•°
            threadVisible: false, currentThread: null, newComment: '', // å¸–å­è¯¦æƒ…ç›¸å…³
            canteenList: [], windowList: [], activeCanteenId: null,
            myPubList: [], myAccList: [],
            dialogVisible: false, chatVisible: false, chatTargetId: null, chatInput: '', chatHistory: [], chatTimer: null,
            form: { title: '', reward: '', locationFrom: '', locationTo: '' }
        },
        created() { this.loadSchools(); },
        methods: {
            // --- åŸºç¡€ ---
            loadSchools() { axios.get('/school/list').then(res => this.schoolList = res.data.data); },
            confirmSchool() { this.currentSchool = this.schoolList.find(s => s.id === this.tempSchoolId); this.schoolDialogVisible = false; this.loadHall(); this.loadCanteens(); },
            changeSchool() { this.schoolDialogVisible = true; },
            handleUserChange() { this.$message.info(`åˆ‡ä¸ºç”¨æˆ· ${this.currentUserId}`); this.refreshAll(); },
            handleTabClick(tab) {
                if (tab.name === 'msg') {
                    this.loadInbox();
                    this.unreadCount = 0; // ç‚¹å‡»æ¶ˆæ¯Tabï¼Œçº¢ç‚¹æ¸…é›¶ï¼
                } else if (tab.name === 'hall') this.loadHall();
                else if (tab.name === 'profile') { this.loadMyPub(); this.loadMyAcc(); }
            },
            refreshAll() { this.loadHall(); this.loadInbox(); },

            // --- è´´å§/ä»»åŠ¡å¤§å… ---
            loadHall() {
                if(!this.currentSchool) return;
                axios.get(`/task/list?schoolId=${this.currentSchool.id}`).then(async res => {
                    let list = res.data.data.records;
                    // é¢„åŠ è½½è¯„è®ºæ•°
                    for (let task of list) {
                        let cRes = await axios.get('/consult/list?taskId=' + task.id);
                        task.consultList = cRes.data.data;
                    }
                    this.taskList = list;
                });
            },
            openThread(task) {
                this.currentThread = task;
                this.threadVisible = true;
            },
            submitComment() {
                if(!this.newComment) return;
                axios.post('/consult/add', { taskId: this.currentThread.id, userId: this.currentUserId, username: 'ç”¨æˆ·'+this.currentUserId, content: this.newComment })
                    .then(() => {
                        this.$message.success('å›å¤æˆåŠŸ'); this.newComment = '';
                        // åˆ·æ–°å½“å‰å¸–å­çš„è¯„è®º
                        axios.get('/consult/list?taskId=' + this.currentThread.id).then(r => {
                            this.currentThread.consultList = r.data.data;
                        });
                    });
            },
            acceptTask(taskId) {
                axios.post('/task/accept', { taskId, userId: this.currentUserId }).then(() => {
                    this.$message.success('æŠ¢å•æˆåŠŸ');
                    this.threadVisible = false; // å…³é—­å¼¹çª—
                    this.loadHall(); // åˆ·æ–°åˆ—è¡¨
                });
            },
            submitTask() {
                let task = { ...this.form, publisherId: this.currentUserId, schoolId: this.currentSchool.id };
                axios.post('/task/publish', task).then(() => { this.$message.success('å‘å¸–æˆåŠŸ'); this.dialogVisible = false; this.loadHall(); });
            },

            // --- æ¶ˆæ¯ (çº¢ç‚¹é€»è¾‘) ---
            loadInbox() {
                axios.get('/message/inbox?userId=' + this.currentUserId).then(res => {
                    this.inboxList = res.data.data;
                    // ç®€å•æ¨¡æ‹Ÿï¼šå¦‚æœæœ‰åˆ—è¡¨ï¼Œå°±æ˜¾ç¤ºçº¢ç‚¹ï¼ˆå®é™…åº”è¯¥æ ¹æ®isReadå­—æ®µï¼Œè¿™é‡Œç®€åŒ–å¤„ç†ï¼‰
                    // åªæœ‰å½“ä¸åœ¨æ¶ˆæ¯Tabæ—¶ï¼Œæ‰æ›´æ–°çº¢ç‚¹
                    if (this.activeTab !== 'msg') {
                        this.unreadCount = this.inboxList.length;
                    }
                });
            },

            // --- å…¶ä»– (é£Ÿå ‚ã€ç§èŠã€ä¸ªäºº) é€»è¾‘ä¿æŒç®€åŒ–ï¼Œä»£ç å¤ç”¨ä¹‹å‰çš„ ---
            loadCanteens() { if(this.currentSchool) axios.get(`/school/canteen/list?schoolId=${this.currentSchool.id}`).then(res => this.canteenList = res.data.data); },
            handleCanteenSelect(id) { axios.get(`/school/window/list?canteenId=${id}`).then(res => this.windowList = res.data.data); },
            loadMyPub() { axios.get('/task/my-publish?userId=' + this.currentUserId).then(res => this.myPubList = res.data.data); },
            loadMyAcc() { axios.get('/task/my-accept?userId=' + this.currentUserId).then(res => this.myAccList = res.data.data); },
            openChat(uid) { if(uid===this.currentUserId) return; this.chatTargetId=uid; this.chatVisible=true; this.loadHistory(); this.chatTimer=setInterval(this.loadHistory,2000); },
            handleCloseChat() { clearInterval(this.chatTimer); },
            loadHistory() { if(this.chatVisible) axios.get(`/message/history?userId1=${this.currentUserId}&userId2=${this.chatTargetId}`).then(r=>{this.chatHistory=r.data.data; this.$nextTick(()=>{let b=document.getElementById('chatBox');if(b)b.scrollTop=b.scrollHeight})}); },
            sendMsg() { if(this.chatInput) axios.post('/message/send',{senderId:this.currentUserId,receiverId:this.chatTargetId,content:this.chatInput}).then(()=>{this.chatInput='';this.loadHistory()}); },

            // å·¥å…·
            stringToColor(str) { return ['#E0E0E0','#FFCCBC','#B3E5FC'][str%3]; }, // ç®€åŒ–é¢œè‰²
            formatTime(t) { return t ? t.substring(5,16) : ''; }
        }
    })
</script>
</body>
</html>